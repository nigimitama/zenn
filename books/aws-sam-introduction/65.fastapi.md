---
title: "例：Lambda Web Adapter + FastAPIによるAPI開発"
---

# はじめに

## Lambda Web Adapter とは

[Lambda Web Adapter](https://github.com/awslabs/aws-lambda-web-adapter) とは、元々サーバレス環境のために作られたわけではない Web フレームワークたち（Express.js, Next.js, Flask, SpringBoot, ASP.NET, Laravel など）を Lambda 上で動かすための拡張機能で、AWS によって提供されています。

![](/images/books/aws-sam-introduction/65-1.png)

この章では例として Python の[FastAPI](https://fastapi.tiangolo.com/)を使い、Lambda Web Adapter を使った API 開発方法について紹介します。

## FastAPI とは

FastAPI は Web フレームワークで、

- [OpenAPI](https://www.openapis.org/)で仕様書を生成でき、[Swagger UI](https://github.com/swagger-api/swagger-ui) や [ReDoc](https://github.com/Redocly/redoc) によるドキュメントの自動生成が可能
- 型を使用するモダンな Python をサポートしている
- 簡潔なコードで API を実装できる

```python
# FastAPIにより作られたAPIの例
from fastapi import FastAPI
app = FastAPI()

@app.get("/")
async def root() -> dict:
    return {"message": "Hello World!"}
```

などの特徴をもっています。

# コード

次のようなファイルを用意していきます。

```
├── samconfig.toml
├── src
│   ├── Dockerfile
│   ├── main.py
│   └── requirements.txt
└── template.yaml
```

## Dockerfile

```Dockerfile
# ベースイメージはLambda用ではない通常のものを使う
FROM python:3.12-slim

# Lambda Web Adapterをコピー
COPY --from=public.ecr.aws/awsguru/aws-lambda-adapter:0.9.1 /lambda-adapter /opt/extensions/lambda-adapter
WORKDIR /var/task

# FastAPIで使うポートの設定
ENV PORT=8000

# ライブラリのインストール
COPY requirements.txt ./
RUN python -m pip install -r requirements.txt

# ソースコードのコピー
COPY . ./

# uvicornサーバーの起動（main:app はmain.pyにappというFastAPIのインスタンスがあることを想定している書き方）
CMD ["sh", "-c", "exec uvicorn --port=$PORT main:app"]
```

## main.py

- \[GET\] /
- \[GET\] /hello
- \[POST\] /hello

の 3 つの API を作ることにします。

```python
from fastapi import FastAPI
from pydantic import BaseModel

app = FastAPI()

@app.get("/")
async def root() -> str:
    # GET (パラメータなし)
    return "Hello World!"


@app.get("/hello")
async def hello_get(text: str, number: int) -> dict:
    # GET (パラメータあり)
    return {"text": text, "number": number}


# pydanticを使うことで入力パラメータのバリデーションを任せることができる
class PostParams(BaseModel):
    text: str
    number: int


@app.post("/hello")
async def hello_post(params: PostParams) -> dict:
    # POST （JSONパラメータ）
    return {"text": params.text, "number": params.number}
```

## requirements.txt

```ini
fastapi==0.116.1
pydantic==2.11.7
uvicorn==0.35.0
```

## template.yaml

複数の API を作りますが、Lambda 関数は 1 つだけ作成します。

ただし、複数のパスへのリクエストを許可するように設定します。

```yaml
AWSTemplateFormatVersion: "2010-09-09"
Transform: AWS::Serverless-2016-10-31

Parameters:
  STAGE:
    Type: String
    AllowedValues:
      - dev
      - prd
    Default: dev

Resources:
  FastAPIGateway:
    Type: AWS::Serverless::Api
    Properties:
      StageName: !Ref STAGE

  # FastAPIを動かすLambda
  FastApiFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub ${AWS::StackName}-FastAPI
      PackageType: Image
      Architectures:
        - x86_64
      Events:
        # ルートパス用のイベント
        RestApiRootPath:
          Type: Api
          Properties:
            Path: /
            Method: ANY # すべてのメソッドを受け付ける
            RestApiId: !Ref FastAPIGateway
        # ルートパス以外のパス用のイベント
        RestApiAllChildPaths:
          Type: Api
          Properties:
            Path: /{proxy+} # {proxy+} はワイルドカードを意味する。ルートパス以外のすべてのパスはこちらで受け取る
            Method: ANY # すべてのメソッドを受け付ける
            RestApiId: !Ref FastAPIGateway

      Timeout: 30
      MemorySize: 512
    Metadata:
      Dockerfile: Dockerfile
      DockerContext: ./src
      DockerTag: python3.12-v1

  FastApiFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub /aws/lambda/${FastApiFunction}
      RetentionInDays: 14

Outputs:
  ApiEndpoint:
    Description: "API endpoint URL"
    Value: !Sub "https://${FastAPIGateway}.execute-api.${AWS::Region}.amazonaws.com/${STAGE}/"
```

## samconfig.toml

```toml
version = 0.1

[default]
[default.global.parameters]
stack_name = "fastapi-example"

[default.build.parameters]
parallel = true

[default.deploy.parameters]
capabilities = "CAPABILITY_IAM"
confirm_changeset = true
resolve_s3 = true
resolve_image_repos = true
```

# デプロイ

先述のファイルを

```sh
sam build
sam validate
sam deploy
```

## 動作確認

作成した API に対してリクエストを送ってみます。

```sh
$ URL="デプロイ後に表示されるURLを入力"

# [GET] / のAPIにリクエストする
$ curl $URL
"Hello World!"

# [GET] /hello のAPIにリクエストする
$ curl -X GET "$URL/hello?text=hoge&number=42"
{"text":"hoge","number":42}

# [POST] /hello のAPIにリクエストする
$ curl -X POST "$URL/hello" -H "Content-Type: application/json" -d '{"text": "fuga", "number": 1}'
{"text":"fuga","number":1}
```

問題なく FastAPI が動作していることが確認できました。

# 参考

- [Lambda Web Adapter でウェブアプリを (ほぼ) そのままサーバーレス化する (2025 年改訂版) - 変化を求めるデベロッパーを応援するウェブマガジン | AWS](https://aws.amazon.com/jp/builders-flash/202301/lambda-web-adapter/)
